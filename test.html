<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>负翁大冒险 - 增强版</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(to right, #2c3e50, #4a6491);
            color: white;
            padding: 20px;
            text-align: center;
            border-bottom: 5px solid #f1c40f;
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .game-area {
            display: flex;
            flex-wrap: wrap;
            padding: 20px;
            gap: 20px;
        }
        
        .player-info {
            flex: 1;
            min-width: 300px;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .assets {
            margin-bottom: 20px;
        }
        
        .asset-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px dashed #ddd;
        }
        
        .properties {
            margin-top: 20px;
        }
        
        .property-item {
            background: white;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border-left: 4px solid #3498db;
        }
        
        .property-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .property-details {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: #666;
        }
        
        .market {
            flex: 2;
            min-width: 400px;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .property-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s;
        }
        
        .property-card:hover {
            transform: translateY(-5px);
        }
        
        .price-trend {
            font-size: 0.9rem;
            margin-top: 5px;
        }
        
        .up {
            color: #27ae60;
        }
        
        .down {
            color: #e74c3c;
        }
        
        .actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .buy-btn {
            background: #2ecc71;
            color: white;
        }
        
        .buy-btn:hover {
            background: #27ae60;
        }
        
        .sell-btn {
            background: #e74c3c;
            color: white;
        }
        
        .sell-btn:hover {
            background: #c0392b;
        }
        
        .card-btn {
            background: #9b59b6;
            color: white;
        }
        
        .card-btn:hover {
            background: #8e44ad;
        }
        
        .bank-btn {
            background: #3498db;
            color: white;
        }
        
        .bank-btn:hover {
            background: #2980b9;
        }
        
        .rob-btn {
            background: #e74c3c;
            color: white;
        }
        
        .rob-btn:hover {
            background: #c0392b;
        }
        
        .travel-btn {
            background: #1abc9c;
            color: white;
        }
        
        .travel-btn:hover {
            background: #16a085;
        }
        
        .end-turn {
            background: #f39c12;
            color: white;
            padding: 10px 20px;
            font-size: 1.1rem;
            margin-top: 20px;
            width: 100%;
        }
        
        .end-turn:hover {
            background: #e67e22;
        }
        
        .events {
            flex: 1;
            min-width: 300px;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .event-log {
            height: 200px;
            overflow-y: auto;
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .log-entry {
            padding: 8px 0;
            border-bottom: 1px dashed #eee;
        }
        
        .news {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border-left: 4px solid #e74c3c;
        }
        
        .card-system {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border-left: 4px solid #9b59b6;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .modal h2 {
            margin-bottom: 20px;
            color: #2c3e50;
            text-align: center;
        }
        
        .problem {
            font-size: 1.2rem;
            margin: 20px 0;
            text-align: center;
        }
        
        .answer-input {
            width: 100%;
            padding: 10px;
            font-size: 1.1rem;
            border: 2px solid #ddd;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .submit-btn {
            background: #2ecc71;
            color: white;
            width: 100%;
            padding: 12px;
            font-size: 1.1rem;
        }
        
        .card-modal {
            text-align: center;
        }
        
        .card-result {
            font-size: 1.3rem;
            margin: 20px 0;
            padding: 15px;
            border-radius: 8px;
            background: #f8f9fa;
        }
        
        .status-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            margin-left: 10px;
        }
        
        .normal {
            background: #2ecc71;
            color: white;
        }
        
        .damaged {
            background: #e67e22;
            color: white;
        }
        
        .destroyed {
            background: #e74c3c;
            color: white;
        }
        
        .jail {
            background: #2c3e50;
            color: white;
        }
        
        .wealth-level {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .level-bar {
            height: 20px;
            background: #ecf0f1;
            border-radius: 10px;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .level-progress {
            height: 100%;
            background: linear-gradient(to right, #3498db, #2ecc71);
            border-radius: 10px;
            transition: width 0.5s;
        }
        
        .mood-bar {
            height: 10px;
            background: #ecf0f1;
            border-radius: 5px;
            margin: 5px 0;
            overflow: hidden;
        }
        
        .mood-progress {
            height: 100%;
            background: linear-gradient(to right, #e74c3c, #f39c12, #2ecc71);
            border-radius: 5px;
            transition: width 0.5s;
        }
        
        .mini-game {
            text-align: center;
            margin: 20px 0;
        }
        
        .game-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 5px;
            margin: 20px auto;
            max-width: 300px;
        }
        
        .grid-cell {
            width: 50px;
            height: 50px;
            background: #3498db;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            cursor: pointer;
        }
        
        .police {
            background: #e74c3c;
        }
        
        .player-pos {
            background: #2ecc71;
        }
        
        .exit {
            background: #f39c12;
        }
        
        .camera {
            background: #9b59b6;
        }
        
        @media (max-width: 768px) {
            .game-area {
                flex-direction: column;
            }
            
            .player-info, .market, .events {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>负翁大冒险 - 增强版</h1>
            <div class="subtitle">管理资产，应对挑战，成为真正的富翁！</div>
        </header>
        
        <div class="game-area">
            <div class="player-info">
                <div class="assets">
                    <h2>资产状况</h2>
                    <div class="asset-item">
                        <span>现金:</span>
                        <span id="cash">1000</span>
                    </div>
                    <div class="asset-item">
                        <span>存款:</span>
                        <span id="deposit">0</span>
                    </div>
                    <div class="asset-item">
                        <span>总资产:</span>
                        <span id="total-assets">1000</span>
                    </div>
                    <div class="asset-item">
                        <span>心情值:</span>
                        <span id="mood">50</span>
                    </div>
                    <div class="mood-bar">
                        <div class="mood-progress" id="mood-progress" style="width: 50%;"></div>
                    </div>
                </div>
                
                <div class="wealth-level">
                    <h2>财富等级</h2>
                    <div id="wealth-level">1</div>
                    <div class="level-bar">
                        <div class="level-progress" id="level-progress" style="width: 10%;"></div>
                    </div>
                    <div id="level-benefits">捐献提高赦免几率</div>
                </div>
                
                <div class="properties">
                    <h2>我的房地产</h2>
                    <div id="properties-list">
                        <!-- 房地产列表将通过JS动态生成 -->
                    </div>
                </div>
                
                <div class="actions">
                    <button class="bank-btn" id="deposit-btn">存款</button>
                    <button class="bank-btn" id="withdraw-btn">取款</button>
                    <button class="card-btn" id="buy-card-btn">购买机遇卡 (200元)</button>
                    <button class="rob-btn" id="rob-bank-btn">抢银行</button>
                    <button class="travel-btn" id="travel-btn">旅游</button>
                    <button class="card-btn" id="donate-btn">捐献</button>
                </div>
                
                <button class="end-turn" id="end-turn">结束回合</button>
            </div>
            
            <div class="market">
                <h2>房地产市场</h2>
                <div id="property-market">
                    <!-- 房地产市场将通过JS动态生成 -->
                </div>
            </div>
            
            <div class="events">
                <h2>事件日志</h2>
                <div class="event-log" id="event-log">
                    <!-- 事件日志将通过JS动态生成 -->
                </div>
                
                <div class="news">
                    <h3>今日新闻</h3>
                    <div id="news-content">科技园区政策利好，房产预计上涨！</div>
                </div>
                
                <div class="card-system">
                    <h3>机遇卡系统</h3>
                    <div id="cards-owned">当前拥有卡片: 0张</div>
                    <button class="card-btn" id="use-card-btn">使用机遇卡</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 银行任务模态框 -->
    <div class="modal" id="bank-job-modal">
        <div class="modal-content">
            <h2>银行职员任务</h2>
            <p>完成计算任务可获得薪水！</p>
            <div class="problem" id="math-problem">10 + 15 = ?</div>
            <input type="number" class="answer-input" id="answer-input" placeholder="输入答案">
            <button class="submit-btn" id="submit-answer">提交答案</button>
        </div>
    </div>
    
    <!-- 卡片结果模态框 -->
    <div class="modal" id="card-modal">
        <div class="modal-content card-modal">
            <h2>机遇卡</h2>
            <div class="card-result" id="card-result">你抽到了现金红包！</div>
            <button class="submit-btn" id="close-card">确定</button>
        </div>
    </div>
    
    <!-- 抢银行小游戏模态框 -->
    <div class="modal" id="rob-bank-modal">
        <div class="modal-content">
            <h2>抢银行 - 躲避警察</h2>
            <p>避开警察和监控，到达出口！你有3次机会。</p>
            <div class="mini-game">
                <div class="game-grid" id="game-grid">
                    <!-- 游戏网格将通过JS动态生成 -->
                </div>
                <div id="game-status">剩余移动次数: 3</div>
            </div>
            <button class="submit-btn" id="close-rob-game">放弃</button>
        </div>
    </div>
    
    <!-- 答题卡模态框 -->
    <div class="modal" id="quiz-card-modal">
        <div class="modal-content">
            <h2>知识问答</h2>
            <p>回答正确可获得奖金！</p>
            <div class="problem" id="quiz-question">问题加载中...</div>
            <input type="text" class="answer-input" id="quiz-answer" placeholder="输入答案">
            <button class="submit-btn" id="submit-quiz">提交答案</button>
        </div>
    </div>
    
    <!-- 旅游模态框 -->
    <div class="modal" id="travel-modal">
        <div class="modal-content">
            <h2>选择旅游目的地</h2>
            <div id="travel-options">
                <!-- 旅游选项将通过JS动态生成 -->
            </div>
            <button class="submit-btn" id="close-travel">取消</button>
        </div>
    </div>

    <script>
        // 游戏状态
        const gameState = {
            cash: 1000,
            deposit: 0,
            properties: [],
            cards: [],
            turn: 1,
            mood: 50,
            wealthLevel: 1,
            wealthExp: 0,
            inJail: false,
            jailTurns: 0,
            donated: 0,
            news: "科技园区政策利好，房产预计上涨！",
            propertyMarket: [
                { id: 1, name: "市中心公寓", basePrice: 500, currentPrice: 500, trend: 0 },
                { id: 2, name: "科技园办公楼", basePrice: 800, currentPrice: 800, trend: 0 },
                { id: 3, name: "海边别墅", basePrice: 1200, currentPrice: 1200, trend: 0 },
                { id: 4, name: "大学城商铺", basePrice: 600, currentPrice: 600, trend: 0 },
                { id: 5, name: "工业区仓库", basePrice: 400, currentPrice: 400, trend: 0 }
            ],
            eventLog: ["游戏开始！你获得了1000元现金。"],
            bankJob: {
                active: false,
                problems: [],
                currentProblem: 0,
                salary: 0
            },
            robGame: {
                grid: [],
                playerPos: { x: 0, y: 0 },
                movesLeft: 3,
                success: false
            },
            travelOptions: [
                { name: "本地公园", cost: 50, moodGain: 10 },
                { name: "海滨度假", cost: 300, moodGain: 30 },
                { name: "雪山之旅", cost: 500, moodGain: 50 },
                { name: "欧洲环游", cost: 1000, moodGain: 80 }
            ]
        };

        // DOM元素
        const cashEl = document.getElementById('cash');
        const depositEl = document.getElementById('deposit');
        const totalAssetsEl = document.getElementById('total-assets');
        const moodEl = document.getElementById('mood');
        const moodProgressEl = document.getElementById('mood-progress');
        const wealthLevelEl = document.getElementById('wealth-level');
        const levelProgressEl = document.getElementById('level-progress');
        const levelBenefitsEl = document.getElementById('level-benefits');
        const propertiesListEl = document.getElementById('properties-list');
        const propertyMarketEl = document.getElementById('property-market');
        const eventLogEl = document.getElementById('event-log');
        const newsContentEl = document.getElementById('news-content');
        const cardsOwnedEl = document.getElementById('cards-owned');
        const bankJobModal = document.getElementById('bank-job-modal');
        const mathProblemEl = document.getElementById('math-problem');
        const answerInputEl = document.getElementById('answer-input');
        const submitAnswerBtn = document.getElementById('submit-answer');
        const cardModal = document.getElementById('card-modal');
        const cardResultEl = document.getElementById('card-result');
        const closeCardBtn = document.getElementById('close-card');
        const robBankModal = document.getElementById('rob-bank-modal');
        const gameGridEl = document.getElementById('game-grid');
        const gameStatusEl = document.getElementById('game-status');
        const closeRobGameBtn = document.getElementById('close-rob-game');
        const quizCardModal = document.getElementById('quiz-card-modal');
        const quizQuestionEl = document.getElementById('quiz-question');
        const quizAnswerEl = document.getElementById('quiz-answer');
        const submitQuizBtn = document.getElementById('submit-quiz');
        const travelModal = document.getElementById('travel-modal');
        const travelOptionsEl = document.getElementById('travel-options');
        const closeTravelBtn = document.getElementById('close-travel');

        // 初始化游戏
        function initGame() {
            updateUI();
            
            // 事件监听
            document.getElementById('end-turn').addEventListener('click', endTurn);
            document.getElementById('buy-card-btn').addEventListener('click', buyCard);
            document.getElementById('use-card-btn').addEventListener('click', useCard);
            document.getElementById('deposit-btn').addEventListener('click', () => bankAction('deposit'));
            document.getElementById('withdraw-btn').addEventListener('click', () => bankAction('withdraw'));
            document.getElementById('rob-bank-btn').addEventListener('click', startRobBank);
            document.getElementById('travel-btn').addEventListener('click', showTravelOptions);
            document.getElementById('donate-btn').addEventListener('click', donate);
            submitAnswerBtn.addEventListener('click', checkAnswer);
            closeCardBtn.addEventListener('click', () => cardModal.style.display = 'none');
            closeRobGameBtn.addEventListener('click', () => robBankModal.style.display = 'none');
            submitQuizBtn.addEventListener('click', checkQuizAnswer);
            closeTravelBtn.addEventListener('click', () => travelModal.style.display = 'none');
            
            // 初始新闻
            newsContentEl.textContent = gameState.news;
        }

        // 更新UI
        function updateUI() {
            // 更新资产
            cashEl.textContent = gameState.cash;
            depositEl.textContent = gameState.deposit;
            totalAssetsEl.textContent = gameState.cash + gameState.deposit;
            moodEl.textContent = gameState.mood;
            moodProgressEl.style.width = `${gameState.mood}%`;
            
            // 更新财富等级
            wealthLevelEl.textContent = gameState.wealthLevel;
            const expNeeded = getExpForNextLevel();
            levelProgressEl.style.width = `${(gameState.wealthExp / expNeeded) * 100}%`;
            updateLevelBenefits();
            
            // 更新房地产列表
            propertiesListEl.innerHTML = '';
            if (gameState.properties.length === 0) {
                propertiesListEl.innerHTML = '<p>暂无房地产</p>';
            } else {
                gameState.properties.forEach(prop => {
                    const statusClass = prop.status === 'damaged' ? 'damaged' : 
                                      prop.status === 'destroyed' ? 'destroyed' : 'normal';
                    const statusText = prop.status === 'damaged' ? '损毁' : 
                                     prop.status === 'destroyed' ? '消失' : '正常';
                    
                    const propertyEl = document.createElement('div');
                    propertyEl.className = 'property-item';
                    propertyEl.innerHTML = `
                        <div class="property-name">${prop.name} 
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </div>
                        <div class="property-details">
                            <span>当前价值: ${prop.currentPrice}</span>
                            <span>${prop.trend > 0 ? '↑' : prop.trend < 0 ? '↓' : '→'} ${Math.abs(prop.trend)}%</span>
                        </div>
                        ${prop.status === 'damaged' ? 
                            `<button class="buy-btn" onclick="repairProperty(${prop.id})">修复 (${Math.round(prop.basePrice * 0.9)})</button>` : 
                            `<button class="sell-btn" onclick="sellProperty(${prop.id})">出售</button>`
                        }
                    `;
                    propertiesListEl.appendChild(propertyEl);
                });
            }
            
            // 更新房地产市场
            propertyMarketEl.innerHTML = '';
            gameState.propertyMarket.forEach(prop => {
                const trendClass = prop.trend > 0 ? 'up' : prop.trend < 0 ? 'down' : '';
                const trendIcon = prop.trend > 0 ? '↑' : prop.trend < 0 ? '↓' : '→';
                
                const marketEl = document.createElement('div');
                marketEl.className = 'property-card';
                marketEl.innerHTML = `
                    <div class="property-name">${prop.name}</div>
                    <div class="property-details">
                        <span>价格: ${prop.currentPrice}</span>
                        <span class="price-trend ${trendClass}">${trendIcon} ${Math.abs(prop.trend)}%</span>
                    </div>
                    <div class="actions">
                        <button class="buy-btn" onclick="buyProperty(${prop.id})">购买</button>
                    </div>
                `;
                propertyMarketEl.appendChild(marketEl);
            });
            
            // 更新事件日志
            eventLogEl.innerHTML = '';
            gameState.eventLog.forEach(log => {
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry';
                logEntry.textContent = log;
                eventLogEl.appendChild(logEntry);
            });
            eventLogEl.scrollTop = eventLogEl.scrollHeight;
            
            // 更新卡片数量
            cardsOwnedEl.textContent = `当前拥有卡片: ${gameState.cards.length}张`;
            
            // 更新按钮状态
            document.getElementById('rob-bank-btn').disabled = gameState.inJail;
            document.getElementById('travel-btn').disabled = gameState.inJail;
            document.getElementById('donate-btn').disabled = gameState.wealthLevel < 5;
        }

        // 获取升级所需经验
        function getExpForNextLevel() {
            return gameState.wealthLevel * 1000;
        }

        // 更新等级福利
        function updateLevelBenefits() {
            let benefits = "";
            if (gameState.wealthLevel >= 5) {
                benefits += "捐献提高赦免几率";
            }
            if (gameState.wealthLevel >= 10) {
                benefits += " | 购买私人飞机";
            }
            if (gameState.wealthLevel >= 100) {
                benefits += " | 建立国家";
            }
            levelBenefitsEl.textContent = benefits || "暂无特殊福利";
        }

        // 购买房地产
        function buyProperty(id) {
            const property = gameState.propertyMarket.find(p => p.id === id);
            if (!property) return;
            
            if (gameState.cash >= property.currentPrice) {
                gameState.cash -= property.currentPrice;
                gameState.properties.push({
                    id: property.id,
                    name: property.name,
                    basePrice: property.currentPrice,
                    currentPrice: property.currentPrice,
                    trend: property.trend,
                    status: 'normal'
                });
                
                addToLog(`购买了${property.name}，花费${property.currentPrice}元`);
                updateUI();
            } else {
                addToLog(`现金不足，无法购买${property.name}`);
            }
        }

        // 出售房地产
        function sellProperty(id) {
            const propertyIndex = gameState.properties.findIndex(p => p.id === id);
            if (propertyIndex === -1) return;
            
            const property = gameState.properties[propertyIndex];
            gameState.cash += property.currentPrice;
            addToLog(`出售了${property.name}，获得${property.currentPrice}元`);
            gameState.properties.splice(propertyIndex, 1);
            updateUI();
        }

        // 修复房地产
        function repairProperty(id) {
            const property = gameState.properties.find(p => p.id === id);
            if (!property || property.status !== 'damaged') return;
            
            const repairCost = Math.round(property.basePrice * 0.9);
            if (gameState.cash >= repairCost) {
                gameState.cash -= repairCost;
                property.status = 'normal';
                addToLog(`修复了${property.name}，花费${repairCost}元`);
                updateUI();
            } else {
                addToLog(`现金不足，无法修复${property.name}`);
            }
        }

        // 银行存款/取款
        function bankAction(action) {
            const amount = parseInt(prompt(`请输入${action === 'deposit' ? '存款' : '取款'}金额:`));
            if (isNaN(amount) || amount <= 0) {
                alert('请输入有效金额');
                return;
            }
            
            if (action === 'deposit') {
                if (gameState.cash >= amount) {
                    gameState.cash -= amount;
                    gameState.deposit += amount;
                    addToLog(`存款${amount}元`);
                } else {
                    alert('现金不足');
                }
            } else {
                if (gameState.deposit >= amount) {
                    gameState.deposit -= amount;
                    gameState.cash += amount;
                    addToLog(`取款${amount}元`);
                } else {
                    alert('存款不足');
                }
            }
            updateUI();
        }

        // 购买机遇卡
        function buyCard() {
            if (gameState.cash >= 200) {
                gameState.cash -= 200;
                gameState.cards.push(generateRandomCard());
                addToLog('购买了一张机遇卡');
                updateUI();
            } else {
                addToLog('现金不足，无法购买机遇卡');
            }
        }

        // 使用机遇卡
        function useCard() {
            if (gameState.cards.length === 0) {
                alert('没有可用的机遇卡');
                return;
            }
            
            const card = gameState.cards.pop();
            applyCardEffect(card);
            updateUI();
        }

        // 生成随机卡片
        function generateRandomCard() {
            const cards = [
                { name: '现金红包', effect: 'cash', value: 500 },
                { name: '存款翻倍利息', effect: 'doubleInterest' },
                { name: '价格冻结', effect: 'freezePrices' },
                { name: '强制交易', effect: 'forcedTrade' },
                { name: '房产增值', effect: 'propertyBoost', value: 1.2 },
                { name: '赦免卡', effect: 'pardon' },
                { name: '答题卡', effect: 'quiz' }
            ];
            
            return cards[Math.floor(Math.random() * cards.length)];
        }

        // 应用卡片效果
        function applyCardEffect(card) {
            cardResultEl.textContent = `你使用了机遇卡：${card.name}`;
            cardModal.style.display = 'flex';
            
            switch(card.effect) {
                case 'cash':
                    gameState.cash += card.value;
                    addToLog(`获得现金红包${card.value}元`);
                    break;
                case 'doubleInterest':
                    // 下一回合利息翻倍逻辑
                    addToLog('下一回合存款利息将翻倍');
                    break;
                case 'freezePrices':
                    // 价格冻结逻辑
                    addToLog('房地产价格将冻结3回合');
                    break;
                case 'forcedTrade':
                    // 强制交易逻辑
                    addToLog('强制交易效果已触发');
                    break;
                case 'propertyBoost':
                    // 房产增值
                    gameState.properties.forEach(prop => {
                        prop.currentPrice = Math.round(prop.currentPrice * card.value);
                    });
                    addToLog('所有房产价值提升20%');
                    break;
                case 'pardon':
                    if (gameState.inJail) {
                        gameState.inJail = false;
                        gameState.jailTurns = 0;
                        addToLog('你被赦免了！重获自由！');
                    } else {
                        addToLog('你获得了赦免卡，可以在入狱时使用');
                        // 将卡片放回
                        gameState.cards.push(card);
                    }
                    break;
                case 'quiz':
                    startQuiz();
                    break;
            }
        }

        // 开始答题卡
        function startQuiz() {
            const questions = [
                { question: "中国的首都是哪个城市？", answer: "北京" },
                { question: "太阳系中最大的行星是？", answer: "木星" },
                { question: "《红楼梦》的作者是谁？", answer: "曹雪芹" },
                { question: "水的化学式是什么？", answer: "H2O" },
                { question: "一年有多少个月？", answer: "12" }
            ];
            
            const randomQuestion = questions[Math.floor(Math.random() * questions.length)];
            quizQuestionEl.textContent = randomQuestion.question;
            quizCardModal.style.display = 'flex';
            quizAnswerEl.value = '';
            quizAnswerEl.focus();
            
            // 存储正确答案
            quizCardModal.dataset.correctAnswer = randomQuestion.answer;
        }

        // 检查答题卡答案
        function checkQuizAnswer() {
            const userAnswer = quizAnswerEl.value.trim();
            const correctAnswer = quizCardModal.dataset.correctAnswer;
            
            if (userAnswer.toLowerCase() === correctAnswer.toLowerCase()) {
                const rewards = [200, 400, 800, 1000, 1500];
                const reward = rewards[Math.floor(Math.random() * rewards.length)];
                gameState.cash += reward;
                addToLog(`回答正确！获得${reward}元奖金`);
                quizCardModal.style.display = 'none';
                updateUI();
            } else {
                alert('答案错误！');
                quizAnswerEl.value = '';
                quizAnswerEl.focus();
            }
        }

        // 开始抢银行
        function startRobBank() {
            if (gameState.inJail) {
                addToLog('你现在在监狱中，无法抢银行！');
                return;
            }
            
            // 初始化抢银行小游戏
            initRobGame();
            robBankModal.style.display = 'flex';
        }

        // 初始化抢银行小游戏
        function initRobGame() {
            gameState.robGame.movesLeft = 3;
            gameState.robGame.success = false;
            
            // 创建5x5网格
            const grid = [];
            for (let i = 0; i < 5; i++) {
                grid[i] = [];
                for (let j = 0; j < 5; j++) {
                    grid[i][j] = 'empty';
                }
            }
            
            // 设置玩家起始位置
            grid[0][0] = 'player';
            gameState.robGame.playerPos = { x: 0, y: 0 };
            
            // 设置出口位置
            grid[4][4] = 'exit';
            
            // 随机放置警察和监控
            for (let i = 0; i < 3; i++) {
                let x, y;
                do {
                    x = Math.floor(Math.random() * 5);
                    y = Math.floor(Math.random() * 5);
                } while (grid[x][y] !== 'empty');
                grid[x][y] = 'police';
            }
            
            for (let i = 0; i < 2; i++) {
                let x, y;
                do {
                    x = Math.floor(Math.random() * 5);
                    y = Math.floor(Math.random() * 5);
                } while (grid[x][y] !== 'empty');
                grid[x][y] = 'camera';
            }
            
            gameState.robGame.grid = grid;
            renderRobGame();
        }

        // 渲染抢银行小游戏
        function renderRobGame() {
            gameGridEl.innerHTML = '';
            gameStatusEl.textContent = `剩余移动次数: ${gameState.robGame.movesLeft}`;
            
            for (let i = 0; i < 5; i++) {
                for (let j = 0; j < 5; j++) {
                    const cell = document.createElement('div');
                    cell.className = 'grid-cell';
                    
                    if (gameState.robGame.grid[i][j] === 'player') {
                        cell.classList.add('player-pos');
                        cell.textContent = 'P';
                    } else if (gameState.robGame.grid[i][j] === 'police') {
                        cell.classList.add('police');
                        cell.textContent = '警';
                    } else if (gameState.robGame.grid[i][j] === 'camera') {
                        cell.classList.add('camera');
                        cell.textContent = '监';
                    } else if (gameState.robGame.grid[i][j] === 'exit') {
                        cell.classList.add('exit');
                        cell.textContent = '出';
                    }
                    
                    cell.addEventListener('click', () => movePlayer(i, j));
                    gameGridEl.appendChild(cell);
                }
            }
        }

        // 移动玩家
        function movePlayer(x, y) {
            if (gameState.robGame.movesLeft <= 0) return;
            
            const playerPos = gameState.robGame.playerPos;
            
            // 检查是否相邻
            if (Math.abs(playerPos.x - x) + Math.abs(playerPos.y - y) !== 1) {
                alert('只能移动到相邻的格子！');
                return;
            }
            
            // 移动玩家
            gameState.robGame.grid[playerPos.x][playerPos.y] = 'empty';
            gameState.robGame.grid[x][y] = 'player';
            gameState.robGame.playerPos = { x, y };
            
            gameState.robGame.movesLeft--;
            
            // 检查是否碰到警察或监控
            if (gameState.robGame.grid[x][y] === 'police' || 
                gameState.robGame.grid[x][y] === 'camera') {
                addToLog('你被警察抓住了！');
                gameState.inJail = true;
                gameState.jailTurns = 3;
                robBankModal.style.display = 'none';
                updateUI();
                return;
            }
            
            // 检查是否到达出口
            if (gameState.robGame.grid[x][y] === 'exit') {
                addToLog('抢银行成功！获得5000元！');
                gameState.cash += 5000;
                gameState.robGame.success = true;
                robBankModal.style.display = 'none';
                updateUI();
                return;
            }
            
            // 检查是否用完移动次数
            if (gameState.robGame.movesLeft <= 0) {
                addToLog('抢银行失败！被警察包围了！');
                gameState.inJail = true;
                gameState.jailTurns = 3;
                robBankModal.style.display = 'none';
                updateUI();
                return;
            }
            
            renderRobGame();
        }

        // 显示旅游选项
        function showTravelOptions() {
            if (gameState.inJail) {
                addToLog('你现在在监狱中，无法旅游！');
                return;
            }
            
            travelOptionsEl.innerHTML = '';
            gameState.travelOptions.forEach(option => {
                const optionEl = document.createElement('div');
                optionEl.className = 'property-card';
                optionEl.innerHTML = `
                    <div class="property-name">${option.name}</div>
                    <div class="property-details">
                        <span>费用: ${option.cost}元</span>
                        <span>心情提升: +${option.moodGain}</span>
                    </div>
                    <button class="buy-btn" onclick="travel('${option.name}')">选择</button>
                `;
                travelOptionsEl.appendChild(optionEl);
            });
            
            travelModal.style.display = 'flex';
        }

        // 旅游
        function travel(destinationName) {
            const destination = gameState.travelOptions.find(opt => opt.name === destinationName);
            if (!destination) return;
            
            if (gameState.cash >= destination.cost) {
                gameState.cash -= destination.cost;
                gameState.mood = Math.min(100, gameState.mood + destination.moodGain);
                addToLog(`去了${destinationName}旅游，心情值提升${destination.moodGain}`);
                travelModal.style.display = 'none';
                updateUI();
            } else {
                alert('现金不足，无法旅游！');
            }
        }

        // 捐献
        function donate() {
            if (gameState.wealthLevel < 5) {
                alert('需要达到财富等级5才能捐献！');
                return;
            }
            
            const amount = parseInt(prompt('请输入捐献金额:'));
            if (isNaN(amount) || amount <= 0) {
                alert('请输入有效金额');
                return;
            }
            
            if (gameState.cash >= amount) {
                gameState.cash -= amount;
                gameState.donated += amount;
                addToLog(`捐献了${amount}元，提高了赦免几率`);
                updateUI();
            } else {
                alert('现金不足！');
            }
        }

        // 结束回合
        function endTurn() {
            gameState.turn++;
            
            // 如果在监狱中
            if (gameState.inJail) {
                gameState.jailTurns--;
                addToLog(`你在监狱中，还有${gameState.jailTurns}回合`);
                
                // 检查是否可以被赦免
                if (gameState.jailTurns <= 0 || (Math.random() < 0.3 + gameState.donated / 10000)) {
                    gameState.inJail = false;
                    gameState.jailTurns = 0;
                    addToLog('你被释放了！');
                }
            } else {
                // 更新房地产价格
                updatePropertyPrices();
                
                // 随机事件
                triggerRandomEvent();
                
                // 存款利息
                if (gameState.deposit > 0) {
                    const interest = Math.round(gameState.deposit * 0.01);
                    gameState.deposit += interest;
                    addToLog(`获得存款利息${interest}元`);
                }
                
                // 心情值自然下降
                gameState.mood = Math.max(0, gameState.mood - 5);
            }
            
            addToLog(`第${gameState.turn}回合开始`);
            updateUI();
        }

        // 更新房地产价格
        function updatePropertyPrices() {
            // 更新市场房地产价格
            gameState.propertyMarket.forEach(prop => {
                const change = (Math.random() * 0.25 - 0.1); // -10% 到 +15%
                const oldPrice = prop.currentPrice;
                prop.currentPrice = Math.round(prop.currentPrice * (1 + change));
                prop.trend = Math.round(((prop.currentPrice - oldPrice) / oldPrice) * 100);
            });
            
            // 更新玩家房地产价格
            gameState.properties.forEach(prop => {
                const marketProp = gameState.propertyMarket.find(p => p.id === prop.id);
                if (marketProp) {
                    const oldPrice = prop.currentPrice;
                    prop.currentPrice = marketProp.currentPrice;
                    prop.trend = Math.round(((prop.currentPrice - oldPrice) / oldPrice) * 100);
                }
            });
        }

        // 触发随机事件
        function triggerRandomEvent() {
            const events = [
                { type: 'priceChange', weight: 4 },
                { type: 'earthquake', weight: 1 },
                { type: 'bankJob', weight: 2 },
                { type: 'news', weight: 3 }
            ];
            
            // 加权随机选择事件
            const totalWeight = events.reduce((sum, event) => sum + event.weight, 0);
            let random = Math.random() * totalWeight;
            let selectedEvent = events[0];
            
            for (const event of events) {
                random -= event.weight;
                if (random <= 0) {
                    selectedEvent = event;
                    break;
                }
            }
            
            // 执行事件
            switch(selectedEvent.type) {
                case 'priceChange':
                    const changeProp = gameState.propertyMarket[Math.floor(Math.random() * gameState.propertyMarket.length)];
                    const change = (Math.random() * 0.3 - 0.1); // -10% 到 +20%
                    const oldPrice = changeProp.currentPrice;
                    changeProp.currentPrice = Math.round(changeProp.currentPrice * (1 + change));
                    changeProp.trend = Math.round(((changeProp.currentPrice - oldPrice) / oldPrice) * 100);
                    
                    addToLog(`突发新闻：${changeProp.name}价格${change > 0 ? '上涨' : '下跌'}了${Math.abs(Math.round(change * 100))}%`);
                    break;
                    
                case 'earthquake':
                    if (gameState.properties.length > 0) {
                        const quakeProp = gameState.properties[Math.floor(Math.random() * gameState.properties.length)];
                        if (Math.random() < 0.5) {
                            quakeProp.status = 'damaged';
                            addToLog(`地震！${quakeProp.name}损毁了，需要修复`);
                        } else {
                            quakeProp.status = 'destroyed';
                            addToLog(`强烈地震！${quakeProp.name}永久消失了`);
                        }
                    }
                    break;
                    
                case 'bankJob':
                    startBankJob();
                    break;
                    
                case 'news':
                    const newsOptions = [
                        "政府推出购房补贴政策，房地产市场活跃！",
                        "经济形势不佳，房地产价格可能下跌。",
                        "新区开发计划公布，相关区域房产看涨。",
                        "银行利率调整，存款收益增加。"
                    ];
                    gameState.news = newsOptions[Math.floor(Math.random() * newsOptions.length)];
                    newsContentEl.textContent = gameState.news;
                    addToLog(`新闻更新：${gameState.news}`);
                    break;
            }
        }

        // 开始银行任务
        function startBankJob() {
            gameState.bankJob.active = true;
            gameState.bankJob.problems = generateMathProblems(5);
            gameState.bankJob.currentProblem = 0;
            gameState.bankJob.salary = Math.round(Math.random() * 200 + 100);
            
            showNextProblem();
            bankJobModal.style.display = 'flex';
        }

        // 生成数学问题
        function generateMathProblems(count) {
            const problems = [];
            for (let i = 0; i < count; i++) {
                const a = Math.floor(Math.random() * 50) + 1;
                const b = Math.floor(Math.random() * 50) + 1;
                const op = Math.random() > 0.5 ? '+' : '-';
                let answer;
                
                if (op === '+') {
                    answer = a + b;
                } else {
                    answer = a - b;
                }
                
                problems.push({
                    question: `${a} ${op} ${b} = ?`,
                    answer: answer
                });
            }
            return problems;
        }

        // 显示下一个问题
        function showNextProblem() {
            if (gameState.bankJob.currentProblem < gameState.bankJob.problems.length) {
                const problem = gameState.bankJob.problems[gameState.bankJob.currentProblem];
                mathProblemEl.textContent = problem.question;
                answerInputEl.value = '';
                answerInputEl.focus();
            } else {
                // 所有问题完成
                gameState.cash += gameState.bankJob.salary;
                addToLog(`完成银行任务，获得薪水${gameState.bankJob.salary}元`);
                bankJobModal.style.display = 'none';
                gameState.bankJob.active = false;
                updateUI();
            }
        }

        // 检查答案
        function checkAnswer() {
            const userAnswer = parseInt(answerInputEl.value);
            const correctAnswer = gameState.bankJob.problems[gameState.bankJob.currentProblem].answer;
            
            if (userAnswer === correctAnswer) {
                gameState.bankJob.currentProblem++;
                showNextProblem();
            } else {
                alert('答案错误，请重新计算！');
                answerInputEl.value = '';
                answerInputEl.focus();
            }
        }

        // 添加日志
        function addToLog(message) {
            gameState.eventLog.push(message);
            if (gameState.eventLog.length > 10) {
                gameState.eventLog.shift();
            }
        }

        // 初始化游戏
        window.onload = initGame;
    </script>
</body>
</html>
